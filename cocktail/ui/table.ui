<?xml version="1.0" encoding="utf-8"?>

<div
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://www.whads.com/ns/cocktail/ui"
    dataState="pending"
    columnsReady="false">

    <ui:resource href="cocktail.ui://styles/table.scss.css"/>
    <ui:decoratedBy function="cocktail.ui.dataBound"/>

    <ui:property name="member">
        <?on change
        this.visibleColumns = new Set(newValue.members());
        ?>
    </ui:property>

    <ui:property
        name="languages"
        type="identifiers"
        reflected="true"
        default="[]"/>

    <ui:property name="visibleColumns"/>

    <?class
    connectedCallback() {
        let table = this;
        // Execute after the browser has calculated the element's layout;
        // otherwise, the scrollbar size calculation is off
        setTimeout(function () {
            table.headingsRow.style.width = `calc(100% - ${table.body.offsetWidth - table.body.clientWidth}px)`;
        }, 1);
    }

    update() {

        let table = this;
        this.dataState = "loading";

        if (!this.columnsReady) {
            this.createColumns();
            this.columnsReady = true;
        }

        this.dataSource
            .load()
            .then(function (data) {
                table.setRows(data);
                table.dataState = "loaded";
            })
    }

    createColumns() {
        for (let member of this.member.members()) {
            let languages = member.translated ? this.languages : [null];
            for (let language of languages) {
                let heading = this.createHeading(member, language);
                this.headingsRow.appendChild(heading);
            }
        }
    }

    createHeading(member, language = null) {
        let heading = this.constructor.Heading.create();
        heading.member = member;
        heading.language = language;
        heading.setAttribute("column", member.name);
        heading.label.innerHTML = member.translate();
        if (language) {
            heading.languageLabel.innerHTML = language; // TODO: translate this
        }
        else {
            heading.languageLabel.style.display = "none";
        }
        return heading;
    }

    setRows(records) {
        for (let record of records) {
            let row = this.createRow(record);
            this.body.appendChild(row);
        }
    }

    createRow(record) {
        let row = document.createElement("tr");
        for (let member of this.member.members()) {
            let languages = member.translated ? this.languages : [null];
            for (let language of languages) {
                let cell = this.createCell(record, member, language);
                row.appendChild(cell);
            }
        }
        return row;
    }

    createCell(record, member, language) {

        let cell = document.createElement("td");
        cell.member = member;
        cell.language = language;
        cell.setAttribute("data-column", member.name);

        // Render the value using a custom component, if available, or fall
        // back to a string reprensetation
        let value = this.dataSource.getValue(record, member, language);
        let displayFactory = member[cocktail.ui.DISPLAY];

        if (displayFactory) {
            let display = cocktail.ui.createDisplay(displayFactory, {object: record, member, language, value});
            cell.appendChild(display);
            display.update();
        }
        else {
            cell.innerHTML = member.translateValue(value);
        }

        return cell;
    }
    ?>

    <div id="loadingSign">
        <ui:translation/>
    </div>

    <table id="table">

        <thead id="head">
            <tr id="headingsRow"/>
        </thead>

        <tbody id="body"/>

        <th ui:component="Heading">
            <span id="label"/>
            <span id="languageLabel"/>
        </th>

    </table>

</div>

